{% extends "base.html" %}

{% block title %}Project Intelligence - BIMCalc{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìö Project Intelligence</h1>
    <p>Search and explore project documents, contracts, and manuals.</p>
</div>

<!-- Search & Filters -->
<div class="card">
    <div class="card-body">
        <form id="searchForm" class="flex gap-2" onsubmit="event.preventDefault(); searchDocuments();">
            <div style="flex: 1;">
                <input type="text" id="searchInput"
                    placeholder="Search documents (e.g., 'warranty period', 'bond application')..."
                    value="{{ query or '' }}" style="padding: 0.75rem; font-size: 1.1rem;">
            </div>
            <div style="width: 200px;">
                <select id="tagFilter" onchange="searchDocuments()" style="padding: 0.75rem;">
                    <option value="all">All Tags</option>
                    <option value="#Contract" {% if tag=='#Contract' %}selected{% endif %}>#Contract</option>
                    <option value="#Manual" {% if tag=='#Manual' %}selected{% endif %}>#Manual</option>
                    <option value="#Electrical" {% if tag=='#Electrical' %}selected{% endif %}>#Electrical</option>
                    <option value="#Quality" {% if tag=='#Quality' %}selected{% endif %}>#Quality</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">Search</button>
        </form>
    </div>
</div>

<!-- Results -->
<div id="resultsContainer" class="stats-grid" style="grid-template-columns: 1fr;">
    <!-- Results will be populated here -->
    <div class="text-center text-muted" style="padding: 2rem;">
        Loading documents...
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const org = '{{ org_id }}';
    const project = '{{ project_id }}';
    let currentPage = 1;

    async function searchDocuments(page = 1) {
        const query = document.getElementById('searchInput').value;
        const tag = document.getElementById('tagFilter').value;
        const container = document.getElementById('resultsContainer');

        container.innerHTML = '<div class="text-center text-muted" style="padding: 2rem;">Searching...</div>';

        try {
            const params = new URLSearchParams({
                org: org,
                project: project,
                page: page,
                page_size: 20
            });

            if (query) params.append('q', query);
            if (tag && tag !== 'all') params.append('tag', tag);

            const response = await fetch(`/api/documents/search?${params}`);
            const data = await response.json();

            currentPage = data.pagination.page;

            if (data.results.length === 0) {
                container.innerHTML = `
                <div class="text-center text-muted" style="padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                    <h3>No documents found</h3>
                    <p>Try adjusting your search terms or filters.</p>
                </div>
            `;
                return;
            }

            // Results
            let html = data.results.map(doc => `
            <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #4299e1;">
                <div class="card-body" style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span class="badge badge-info">${doc.document_type || 'Unknown'}</span>
                            ${(doc.tags || []).map(t => `<span class="badge" style="background: #edf2f7; color: #4a5568;">${t}</span>`).join('')}
                        </div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #2d3748;">${doc.title}</h3>
                        <div class="text-muted" style="font-size: 0.875rem;">
                            Source: ${doc.source_file}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

            // Pagination controls
            const pagination = data.pagination;
            html += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1rem; background: #f7fafc; border-radius: 0.375rem;">
                <div class="text-muted">
                    Showing ${((pagination.page - 1) * pagination.page_size) + 1}-${Math.min(pagination.page * pagination.page_size, pagination.total_count)} of ${pagination.total_count} documents
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="searchDocuments(${pagination.page - 1})" 
                            class="btn btn-secondary" 
                            ${!pagination.has_prev ? 'disabled' : ''}>
                        ‚Üê Previous
                    </button>
                    <div style="padding: 0.5rem 1rem; background: white; border-radius: 0.375rem; border: 1px solid #cbd5e0;">
                        Page ${pagination.page} of ${pagination.total_pages}
                    </div>
                    <button onclick="searchDocuments(${pagination.page + 1})" 
                            class="btn btn-secondary"
                            ${!pagination.has_next ? 'disabled' : ''}>
                        Next ‚Üí
                    </button>
                </div>
            </div>
        `;

            container.innerHTML = html;

        } catch (error) {
            console.error('Search failed:', error);
            container.innerHTML = '<div class="message message-error">Search failed. Please try again.</div>';
        }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => searchDocuments(1));
</script>
{% endblock %}