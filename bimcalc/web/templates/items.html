{% extends "base.html" %}

{% block title %}Items - BIMCalc{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Revit Items</h1>
    <p>Browsing {{ total }} items from {{ project_id }} in {{ org_id }}</p>
</div>

<!-- Search and Filter Form -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" action="/items" style="display: flex; gap: 1rem; align-items: flex-end; padding: 1rem;">
        <input type="hidden" name="org" value="{{ org_id }}">
        <input type="hidden" name="project" value="{{ project_id }}">

        <div style="flex: 1;">
            <label for="search" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üîç Search</label>
            <input type="search" id="search" name="search" value="{{ search }}"
                placeholder="Search family, type, category..."
                style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
        </div>

        <div style="min-width: 200px;">
            <label for="category" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üìÅ Category</label>
            <select id="category" name="category"
                style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if category==cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="/items?org={{ org_id }}&project={{ project_id }}" class="btn"
                style="text-decoration: none;">Clear</a>
        </div>
    </form>
</div>

<!-- Summary Stats -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 1.5rem;">
    <div class="stat-card primary">
        <div class="label">Total Items</div>
        <div class="value" style="font-size: 2rem;">{{ total }}</div>
    </div>
    <div class="stat-card success">
        <div class="label">Current Page</div>
        <div class="value" style="font-size: 2rem;">{{ page }} / {{ total_pages }}</div>
    </div>
    <div class="stat-card info">
        <div class="label">Per Page</div>
        <div class="value" style="font-size: 2rem;">{{ per_page }}</div>
    </div>
</div>

<!-- Items Table -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <span>üì¶ Revit Items</span>
        <a href="/items/export?org={{ org_id }}&project={{ project_id }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}"
            class="btn btn-primary"
            style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
            <span>üì•</span>
            <span>Export to Excel</span>
        </a>
    </div>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Family</th>
                <th>Type</th>
                <th>Category</th>
                <th>Classification</th>
                <th>Canonical Key</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Dimensions</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>
                    <a href="/items/{{ item.id }}?org={{ org_id }}&project={{ project_id }}"
                        style="text-decoration: none; color: inherit;">
                        <strong>{{ item.family }}</strong>
                    </a>
                </td>
                <td>{{ item.type_name }}</td>
                <td>
                    <span class="badge badge-info">{{ item.category or "N/A" }}</span>
                </td>
                <td>
                    {% if item.classification_code %}
                    <span class="badge badge-success">{{ item.classification_code }}</span>
                    {% else %}
                    <span class="badge" style="background: #e2e8f0; color: #718096;">Unknown</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.canonical_key %}
                    <code
                        style="font-size: 0.75rem; color: #4a5568;">{{ item.canonical_key[:40] }}{% if item.canonical_key|length > 40 %}...{% endif %}</code>
                    {% else %}
                    <span style="color: #cbd5e0;">-</span>
                    {% endif %}
                </td>
                <td style="text-align: right;">{{ item.quantity or "-" }}</td>
                <td>{{ item.unit or "-" }}</td>
                <td>
                    {% if item.width_mm or item.height_mm or item.dn_mm %}
                    <small style="color: #718096;">
                        {% if item.width_mm and item.height_mm %}
                        {{ item.width_mm }}√ó{{ item.height_mm }}mm
                        {% elif item.dn_mm %}
                        DN{{ item.dn_mm }}
                        {% endif %}
                        {% if item.angle_deg %}
                        ‚à†{{ item.angle_deg }}¬∞
                        {% endif %}
                    </small>
                    {% else %}
                    <span style="color: #cbd5e0;">-</span>
                    {% endif %}
                </td>
                <td>
                    <small style="color: #a0aec0;">
                        {{ item.created_at.strftime("%Y-%m-%d %H:%M") if item.created_at else "-" }}
                    </small>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="/items?org={{ org_id }}&project={{ project_id }}&page=1">¬´ First</a>
        <a href="/items?org={{ org_id }}&project={{ project_id }}&page={{ page - 1 }}">‚Äπ Prev</a>
        {% endif %}

        {% for p in range([1, page - 2]|max, [total_pages, page + 2]|min + 1) %}
        {% if p == page %}
        <span class="active">{{ p }}</span>
        {% else %}
        <a href="/items?org={{ org_id }}&project={{ project_id }}&page={{ p }}">{{ p }}</a>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %} <a href="/items?org={{ org_id }}&project={{ project_id }}&page={{ page + 1 }}">Next
            ‚Ä∫</a>
            <a href="/items?org={{ org_id }}&project={{ project_id }}&page={{ total_pages }}">Last ¬ª</a>
            {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="message message-info" style="margin: 1rem;">
        <strong>No items found</strong><br />
        Upload a Revit schedule via <a href="/ingest?org={{ org_id }}&project={{ project_id }}">Ingest</a> to get
        started.
    </div>
    {% endif %}
</div>

<!-- Item Details Legend -->
<div class="card">
    <div class="card-header">‚ÑπÔ∏è Understanding Items</div>
    <div style="line-height: 1.8;">
        <p><strong>Canonical Key</strong>: Normalized, project-agnostic identifier used for matching across projects</p>
        <p><strong>Classification Code</strong>: OmniClass/UniClass code from trust hierarchy (family ‚Üí curated map ‚Üí
            category ‚Üí heuristics)</p>
        <p><strong>Dimensions</strong>: Parsed from family/type names (width√óheight for cable trays, DN for pipes, angle
            for elbows)</p>
        <p><strong>Material</strong>: Extracted material property (galvanized, stainless, PVC, etc.)</p>
    </div>
</div>

{% endblock %}