{% extends "base.html" %}

{% block title %}Progress - BIMCalc{% endblock %}

{% block extra_styles %}
<style>
    .progress-ring {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        position: relative;
    }
    .progress-ring svg {
        transform: rotate(-90deg);
    }
    .progress-ring-circle {
        transition: stroke-dashoffset 0.35s;
        transform-origin: 50% 50%;
    }
    .progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: 700;
        color: #2d3748;
    }
    .workflow-stages {
        display: grid;
        gap: 1rem;
        margin: 2rem 0;
    }
    .stage {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid #cbd5e0;
    }
    .stage.completed { border-left-color: #48bb78; }
    .stage.in_progress { border-left-color: #4299e1; }
    .stage.not_started { border-left-color: #e2e8f0; }
    .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .stage-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
    }
    .stage-status {
        font-size: 0.875rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
    }
    .stage-status.completed {
        background: #c6f6d5;
        color: #22543d;
    }
    .stage-status.in_progress {
        background: #bee3f8;
        color: #2c5282;
    }
    .stage-status.not_started {
        background: #e2e8f0;
        color: #718096;
    }
    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.75rem 0;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4299e1, #48bb78);
        transition: width 0.3s ease;
    }
    .stage-description {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>üìà Cost Estimation Progress</h1>
        <p>Workflow tracking for {{ project_id }} in {{ org_id }}</p>
    </div>
    <div>
        <a href="/progress?org={{ org_id }}&project={{ project_id }}&view=executive"
           class="btn btn-primary"
           style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
            <span>üéØ</span>
            <span>Executive View</span>
        </a>
    </div>
</div>

<!-- Overall Progress Card -->
<div class="card">
    <div class="flex flex-between flex-center">
        <div style="flex: 1;">
            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">
                Overall Completion
            </h2>
            <p style="color: #718096;">
                {% if metrics.overall_status == 'completed' %}
                    ‚úÖ Project cost estimation completed
                {% elif metrics.overall_status == 'in_progress' %}
                    üîÑ Cost estimation in progress
                {% else %}
                    ‚è∏Ô∏è Cost estimation not started
                {% endif %}
            </p>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: #a0aec0;">
                Last computed: {{ metrics.computed_at.strftime('%Y-%m-%d %H:%M UTC') }}
            </p>
        </div>
        <div class="progress-ring">
            <svg width="200" height="200">
                <circle
                    cx="100"
                    cy="100"
                    r="90"
                    stroke="#e2e8f0"
                    stroke-width="12"
                    fill="none"
                />
                <circle
                    class="progress-ring-circle"
                    cx="100"
                    cy="100"
                    r="90"
                    stroke="{% if metrics.overall_completion >= 75 %}#48bb78{% elif metrics.overall_completion >= 50 %}#4299e1{% else %}#ed8936{% endif %}"
                    stroke-width="12"
                    fill="none"
                    stroke-dasharray="{{ 2 * 3.14159 * 90 }}"
                    stroke-dashoffset="{{ 2 * 3.14159 * 90 * (1 - metrics.overall_completion / 100) }}"
                    stroke-linecap="round"
                />
            </svg>
            <div class="progress-value">{{ "%.0f"|format(metrics.overall_completion) }}%</div>
        </div>
    </div>
</div>

<!-- Workflow Stages -->
<div class="card">
    <div class="card-header">üîÑ Workflow Stages</div>
    <div class="workflow-stages">
        <!-- Stage 1: Import -->
        <div class="stage {{ metrics.stage_import.status }}">
            <div class="stage-header">
                <div class="stage-name">1Ô∏è‚É£ {{ metrics.stage_import.name }}</div>
                <div class="stage-status {{ metrics.stage_import.status }}">
                    {% if metrics.stage_import.status == 'completed' %}‚úì Completed{% elif metrics.stage_import.status == 'in_progress' %}‚è≥ In Progress{% else %}‚òê Not Started{% endif %}
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: {{ metrics.stage_import.completion_percent }}%"></div>
            </div>
            <div class="flex flex-between">
                <span style="font-weight: 600; color: #4a5568;">{{ "%.0f"|format(metrics.stage_import.completion_percent) }}%</span>
                <span style="color: #718096;">{{ metrics.stage_import.items_completed }} / {{ metrics.stage_import.items_total }}</span>
            </div>
            <div class="stage-description">{{ metrics.stage_import.description }}</div>
        </div>

        <!-- Stage 2: Classification -->
        <div class="stage {{ metrics.stage_classification.status }}">
            <div class="stage-header">
                <div class="stage-name">2Ô∏è‚É£ {{ metrics.stage_classification.name }}</div>
                <div class="stage-status {{ metrics.stage_classification.status }}">
                    {% if metrics.stage_classification.status == 'completed' %}‚úì Completed{% elif metrics.stage_classification.status == 'in_progress' %}‚è≥ In Progress{% else %}‚òê Not Started{% endif %}
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: {{ metrics.stage_classification.completion_percent }}%"></div>
            </div>
            <div class="flex flex-between">
                <span style="font-weight: 600; color: #4a5568;">{{ "%.0f"|format(metrics.stage_classification.completion_percent) }}%</span>
                <span style="color: #718096;">{{ metrics.stage_classification.items_completed }} / {{ metrics.stage_classification.items_total }}</span>
            </div>
            <div class="stage-description">{{ metrics.stage_classification.description }}</div>
        </div>

        <!-- Stage 3: Matching -->
        <div class="stage {{ metrics.stage_matching.status }}">
            <div class="stage-header">
                <div class="stage-name">3Ô∏è‚É£ {{ metrics.stage_matching.name }}</div>
                <div class="stage-status {{ metrics.stage_matching.status }}">
                    {% if metrics.stage_matching.status == 'completed' %}‚úì Completed{% elif metrics.stage_matching.status == 'in_progress' %}‚è≥ In Progress{% else %}‚òê Not Started{% endif %}
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: {{ metrics.stage_matching.completion_percent }}%"></div>
            </div>
            <div class="flex flex-between">
                <span style="font-weight: 600; color: #4a5568;">{{ "%.0f"|format(metrics.stage_matching.completion_percent) }}%</span>
                <span style="color: #718096;">{{ metrics.stage_matching.items_completed }} / {{ metrics.stage_matching.items_total }}</span>
            </div>
            <div class="stage-description">{{ metrics.stage_matching.description }}</div>
        </div>

        <!-- Stage 4: Review -->
        <div class="stage {{ metrics.stage_review.status }}">
            <div class="stage-header">
                <div class="stage-name">4Ô∏è‚É£ {{ metrics.stage_review.name }}</div>
                <div class="stage-status {{ metrics.stage_review.status }}">
                    {% if metrics.stage_review.status == 'completed' %}‚úì Completed{% elif metrics.stage_review.status == 'in_progress' %}‚è≥ In Progress{% else %}‚òê Not Started{% endif %}
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: {{ metrics.stage_review.completion_percent }}%"></div>
            </div>
            <div class="flex flex-between">
                <span style="font-weight: 600; color: #4a5568;">{{ "%.0f"|format(metrics.stage_review.completion_percent) }}%</span>
                <span style="color: #718096;">{{ metrics.stage_review.items_completed }} / {{ metrics.stage_review.items_total }}</span>
            </div>
            <div class="stage-description">{{ metrics.stage_review.description }}</div>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="label">Total Items</div>
        <div class="value">{{ metrics.total_items }}</div>
        <div class="description">From Revit schedules</div>
    </div>

    <div class="stat-card success">
        <div class="label">Matched Items</div>
        <div class="value">{{ metrics.matched_items }}</div>
        <div class="description">{{ "%.1f"|format((metrics.matched_items / metrics.total_items * 100) if metrics.total_items > 0 else 0) }}% matched</div>
    </div>

    <div class="stat-card warning">
        <div class="label">Pending Review</div>
        <div class="value">{{ metrics.pending_review }}</div>
        <div class="description">Need manual approval</div>
    </div>

    <div class="stat-card danger">
        <div class="label">Critical Flags</div>
        <div class="value">{{ metrics.flagged_critical }}</div>
        <div class="description">Require immediate attention</div>
    </div>
</div>

<!-- Charts Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- Confidence Distribution -->
    <div class="card">
        <div class="card-header">üìä Match Confidence Distribution</div>
        <div style="padding: 1rem;">
            <canvas id="confidenceChart" width="400" height="300"></canvas>
        </div>
        <div style="padding: 0 1rem 1rem 1rem; font-size: 0.875rem; color: #718096;">
            <p><strong>High (‚â•85%):</strong> Auto-approved, no review needed</p>
            <p><strong>Medium (70-84%):</strong> Requires manual review</p>
            <p><strong>Low (&lt;70%):</strong> Multiple candidates, user must decide</p>
        </div>
    </div>

    <!-- Classification Coverage -->
    <div class="card">
        <div class="card-header">üèóÔ∏è Classification Coverage (Top 5)</div>
        <div style="padding: 1rem;">
            {% if metrics.classification_coverage %}
            <canvas id="classificationChart" width="400" height="300"></canvas>
            {% else %}
            <div class="message message-info">
                <strong>No classification data available</strong><br/>
                Items need classification codes to show coverage.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Classification Breakdown Table -->
{% if metrics.classification_coverage %}
<div class="card">
    <div class="card-header">üìã Classification Breakdown</div>
    <table>
        <thead>
            <tr>
                <th>Classification Code</th>
                <th style="text-align: right;">Total Items</th>
                <th style="text-align: right;">Matched</th>
                <th>Progress</th>
                <th style="text-align: center;">Coverage</th>
            </tr>
        </thead>
        <tbody>
            {% for cls in metrics.classification_coverage %}
            <tr>
                <td><strong>{{ cls.code }}</strong></td>
                <td style="text-align: right;">{{ cls.total }}</td>
                <td style="text-align: right;">{{ cls.matched }}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 100px; height: 20px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ cls.percent }}%; height: 100%; background: #48bb78;"></div>
                        </div>
                    </div>
                </td>
                <td style="text-align: center;">
                    <span class="badge {% if cls.percent >= 80 %}badge-success{% elif cls.percent >= 50 %}badge-advisory{% else %}badge-critical{% endif %}">
                        {{ "%.1f"|format(cls.percent) }}%
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">‚ö° Next Steps</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
        {% if metrics.pending_review > 0 %}
        <a href="/review?org={{ org_id }}&project={{ project_id }}" class="btn btn-primary" style="text-align: center; padding: 1rem;">
            üìã Review {{ metrics.pending_review }} Items
        </a>
        {% endif %}
        {% if metrics.matched_items < metrics.total_items %}
        <a href="/match?org={{ org_id }}&project={{ project_id }}" class="btn btn-primary" style="text-align: center; padding: 1rem;">
            üîç Continue Matching
        </a>
        {% endif %}
        {% if metrics.flagged_critical > 0 %}
        <a href="/review?org={{ org_id }}&project={{ project_id }}&severity=Critical-Veto" class="btn btn-danger" style="text-align: center; padding: 1rem;">
            ‚ö†Ô∏è Resolve {{ metrics.flagged_critical }} Flags
        </a>
        {% endif %}
        <a href="/reports?org={{ org_id }}&project={{ project_id }}" class="btn btn-success" style="text-align: center; padding: 1rem;">
            üìä Generate Report
        </a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Confidence Distribution Chart
const confidenceCtx = document.getElementById('confidenceChart');
new Chart(confidenceCtx, {
    type: 'doughnut',
    data: {
        labels: ['High (‚â•85%)', 'Medium (70-84%)', 'Low (<70%)'],
        datasets: [{
            data: [{{ metrics.confidence_high }}, {{ metrics.confidence_medium }}, {{ metrics.confidence_low }}],
            backgroundColor: ['#48bb78', '#4299e1', '#f56565'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

{% if metrics.classification_coverage %}
// Classification Coverage Chart
const classCtx = document.getElementById('classificationChart');
new Chart(classCtx, {
    type: 'bar',
    data: {
        labels: [{% for cls in metrics.classification_coverage %}'{{ cls.code }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Matched',
            data: [{% for cls in metrics.classification_coverage %}{{ cls.matched }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#48bb78'
        }, {
            label: 'Unmatched',
            data: [{% for cls in metrics.classification_coverage %}{{ cls.total - cls.matched }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#e2e8f0'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                stacked: true
            },
            y: {
                stacked: true,
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
