{% extends "base.html" %}

{% block title %}Item Details - BIMCalc{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1>{{ item.family }} / {{ item.type_name }}</h1>
            <p>Item Details for {{ project_id }} in {{ org_id }}</p>
        </div>
        <a href="/items?org={{ org_id }}&project={{ project_id }}" class="btn" style="text-decoration: none;">
            ‚Üê Back to Items
        </a>
    </div>
</div>

<!-- Classification & Identification -->
<div class="card">
    <div class="card-header">üè∑Ô∏è Classification & Identification</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Family</label>
                <p style="font-size: 1.125rem; margin: 0;">{{ item.family }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Type</label>
                <p style="font-size: 1.125rem; margin: 0;">{{ item.type_name }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Category</label>
                <p style="margin: 0;">
                    {% if item.category %}
                    <span class="badge badge-info">{{ item.category }}</span>
                    {% else %}
                    <span style="color: #cbd5e0;">Not specified</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">System
                    Type</label>
                <p style="margin: 0;">{{ item.system_type or "-" }}</p>
            </div>
        </div>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Classification
                    Code</label>
                <p style="margin: 0;">
                    {% if item.classification_code %}
                    <span class="badge badge-success" style="font-size: 1rem;">{{ item.classification_code }}</span>
                    {% else %}
                    <span class="badge" style="background: #e2e8f0; color: #718096;">Unknown</span>
                    {% endif %}
                </p>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Canonical
                    Key</label>
                <p style="margin: 0;">
                    {% if item.canonical_key %}
                    <code
                        style="padding: 0.5rem; background: #f7fafc; border-radius: 0.25rem; display: inline-block; word-break: break-all;">{{ item.canonical_key }}</code>
                    {% else %}
                    <span style="color: #cbd5e0;">Not generated</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Quantities & Units -->
<div class="card">
    <div class="card-header">üìä Quantities & Units</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Quantity</label>
                <p style="font-size: 1.5rem; margin: 0; font-weight: 600; color: #2d3748;">
                    {{ item.quantity if item.quantity else "-" }}
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Unit</label>
                <p style="font-size: 1.125rem; margin: 0;">{{ item.unit or "-" }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Physical Attributes -->
<div class="card">
    <div class="card-header">üìê Physical Attributes</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Width</label>
                <p style="margin: 0;">{{ item.width_mm }}mm {% if not item.width_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Height</label>
                <p style="margin: 0;">{{ item.height_mm }}mm {% if not item.height_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">DN
                    (Diameter)</label>
                <p style="margin: 0;">{{ item.dn_mm }}mm {% if not item.dn_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Angle</label>
                <p style="margin: 0;">{{ item.angle_deg }}¬∞ {% if not item.angle_deg %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Material</label>
                <p style="margin: 0;">{{ item.material or "-" }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Metadata & Audit -->
<div class="card">
    <div class="card-header">üìã Metadata & Audit Trail</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Item ID</label>
                <p style="margin: 0;"><code style="font-size: 0.875rem;">{{ item.id }}</code></p>
            </div>
            <div>
                <label
                    style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Organization</label>
                <p style="margin: 0;">{{ item.org_id }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Project</label>
                <p style="margin: 0;">{{ item.project_id }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Source
                    File</label>
                <p style="margin: 0; word-break: break-all;">{{ item.source_file or "-" }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Created
                    At</label>
                <p style="margin: 0;">{{ item.created_at.strftime("%Y-%m-%d %H:%M:%S") if item.created_at else "-" }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Additional Attributes (if any) -->
{% if item.attributes %}
<div class="card">
    <div class="card-header">‚öôÔ∏è Additional Attributes</div>
    <div style="padding: 1.5rem;">
        <pre
            style="background: #f7fafc; padding: 1rem; border-radius: 0.375rem; overflow-x: auto;">{{ item.attributes | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

<!-- Intelligence Insights -->
<div class="card" id="intelligence-section" style="border-left: 4px solid #805ad5;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <span>üß† Intelligence Insights</span>
        <span class="badge" style="background: #e9d8fd; color: #553c9a;">AI Powered</span>
    </div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">

            <!-- Risk Analysis Widget -->
            <div id="risk-widget">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #2d3748;">üõ°Ô∏è Compliance Risk Analysis</h3>
                <div id="risk-loading" style="color: #718096; font-style: italic;">
                    Analyzing item compliance...
                </div>
                <div id="risk-content" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div id="risk-score-circle"
                            style="width: 60px; height: 60px; border-radius: 50%; background: #edf2f7; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; color: #2d3748; border: 4px solid #cbd5e0;">
                            --
                        </div>
                        <div>
                            <div id="risk-level" style="font-weight: 700; font-size: 1.1rem;">--</div>
                            <div style="font-size: 0.875rem; color: #718096;">Risk Score</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #4a5568;">Contributing Factors:</h4>
                        <ul id="risk-factors"
                            style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: #4a5568;">
                            <!-- Populated by JS -->
                        </ul>
                    </div>

                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #4a5568;">Recommendations:</h4>
                        <ul id="risk-recommendations"
                            style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: #4a5568;">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
                <div id="risk-error" style="display: none; color: #e53e3e; font-size: 0.9rem;">
                    Failed to load risk analysis.
                </div>
            </div>

            <!-- Document Recommendations Widget -->
            <div id="rag-widget">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #2d3748;">üìÑ Suggested Documents</h3>
                <div id="rag-loading" style="color: #718096; font-style: italic;">
                    Searching knowledge base...
                </div>
                <div id="rag-content" style="display: none;">
                    <div id="rag-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Populated by JS -->
                    </div>
                    <div id="rag-empty" style="display: none; color: #718096; font-size: 0.9rem; font-style: italic;">
                        No relevant documents found.
                    </div>
                </div>
                <div id="rag-error" style="display: none; color: #e53e3e; font-size: 0.9rem;">
                    Failed to load recommendations.
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemId = "{{ item.id }}";

        // 1. Fetch Risk Analysis
        fetch(`/api/intelligence/risk/${itemId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                document.getElementById('risk-loading').style.display = 'none';
                document.getElementById('risk-content').style.display = 'block';

                // Update Score & Level
                const scoreCircle = document.getElementById('risk-score-circle');
                scoreCircle.textContent = Math.round(data.score);

                const riskLevel = document.getElementById('risk-level');
                riskLevel.textContent = data.level + " Risk";

                // Color coding
                let color = '#48bb78'; // Green (Low)
                if (data.level === 'High') color = '#f56565';
                else if (data.level === 'Medium') color = '#ed8936';

                scoreCircle.style.borderColor = color;
                scoreCircle.style.color = color;
                riskLevel.style.color = color;

                // Factors
                const factorsList = document.getElementById('risk-factors');
                factorsList.innerHTML = '';
                for (const [key, factor] of Object.entries(data.factors)) {
                    if (factor.score > 0) {
                        const li = document.createElement('li');
                        li.textContent = `${factor.status} (+${factor.score})`;
                        factorsList.appendChild(li);
                    }
                }
                if (factorsList.children.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "No significant risk factors detected.";
                    li.style.color = "#718096";
                    li.style.fontStyle = "italic";
                    factorsList.appendChild(li);
                }

                // Recommendations
                const recsList = document.getElementById('risk-recommendations');
                recsList.innerHTML = '';
                data.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recsList.appendChild(li);
                });
                if (data.recommendations.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "No actions required.";
                    li.style.color = "#718096";
                    li.style.fontStyle = "italic";
                    recsList.appendChild(li);
                }
            })
            .catch(error => {
                console.error('Error fetching risk:', error);
                document.getElementById('risk-loading').style.display = 'none';
                document.getElementById('risk-error').style.display = 'block';
            });

        // 2. Fetch Document Recommendations
        fetch(`/api/intelligence/recommendations/${itemId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                document.getElementById('rag-loading').style.display = 'none';
                document.getElementById('rag-content').style.display = 'block';

                const list = document.getElementById('rag-list');
                list.innerHTML = '';

                if (data.length === 0) {
                    document.getElementById('rag-empty').style.display = 'block';
                    return;
                }

                data.forEach(doc => {
                    const item = document.createElement('div');
                    item.style.padding = '0.75rem';
                    item.style.background = '#f7fafc';
                    item.style.borderRadius = '0.5rem';
                    item.style.borderLeft = '3px solid #4299e1';

                    item.innerHTML = `
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.25rem;">
                            <a href="#" style="text-decoration: none; color: inherit;">${doc.title}</a>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #718096;">
                            <span>${doc.document_type}</span>
                            <span>${doc.relevance}% Match</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                document.getElementById('rag-loading').style.display = 'none';
                document.getElementById('rag-error').style.display = 'block';
            });
    });
</script>

<!-- Actions -->
<div class="card">
    <div class="card-header">‚ö° Actions</div>
    <div style="padding: 1.5rem; display: flex; gap: 0.75rem;">
        <a href="/items?org={{ org_id }}&project={{ project_id }}" class="btn" style="text-decoration: none;">
            ‚Üê Back to Items List
        </a>
        <button
            onclick="if(confirm('Are you sure you want to delete this item?')) { fetch('/items/{{ item.id }}', {method: 'DELETE'}).then(() => window.location='/items?org={{ org_id }}&project={{ project_id }}'); }"
            class="btn" style="background: #f56565; color: white;">
            üóëÔ∏è Delete Item
        </button>
    </div>
</div>

{% endblock %}