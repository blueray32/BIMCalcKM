{% extends "base.html" %}

{% block title %}Compliance Checker - BIMCalc{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚úÖ Compliance Checker</h1>
    <p>Automated specification compliance verification using AI.</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="label">Total Checks</div>
        <div class="value" id="stat-total">-</div>
        <div class="description">Items checked against rules</div>
    </div>
    <div class="stat-card success">
        <div class="label">Passed</div>
        <div class="value" id="stat-passed">-</div>
        <div class="description">Compliant items</div>
    </div>
    <div class="stat-card danger">
        <div class="label">Failed</div>
        <div class="value" id="stat-failed">-</div>
        <div class="description">Non-compliant items</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Warnings</div>
        <div class="value" id="stat-warnings">-</div>
        <div class="description">Data missing or N/A</div>
    </div>
</div>

<div class="flex gap-2" style="align-items: flex-start;">
    <!-- Left Column: Rules & Upload -->
    <div style="flex: 1;">
        <div class="card">
            <div class="card-header flex flex-between flex-center">
                <span>üìú Specification Rules</span>
                <button class="btn btn-primary" onclick="document.getElementById('spec-upload').click()">
                    + Upload Spec (PDF/Text)
                </button>
                <input type="file" id="spec-upload" style="display: none;" onchange="uploadSpec(this)">
            </div>
            <div class="card-body">
                <div id="rules-list" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">No rules loaded. Upload a specification to extract rules.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Results -->
    <div style="flex: 2;">
        <div class="card">
            <div class="card-header flex flex-between flex-center">
                <span>üîç Check Results</span>
                <button class="btn btn-success" onclick="runCheck()">
                    ‚ñ∂ Run Compliance Check
                </button>
            </div>
            <div class="card-body">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Item</th>
                            <th>Rule</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" class="text-center text-muted">Run a check to see results.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const orgId = urlParams.get('org') || 'default';
    const projectId = urlParams.get('project') || 'default';

    async function uploadSpec(input) {
        if (!input.files || !input.files[0]) return;

        const formData = new FormData();
        formData.append('file', input.files[0]);
        formData.append('org_id', orgId);
        formData.append('project_id', projectId);

        try {
            document.body.classList.add('htmx-request'); // Show loading
            const response = await fetch('/api/compliance/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (response.ok) {
                showToast(`Success: Extracted ${data.rule_count} rules!`, 'success');
                loadRules();
            } else {
                showToast('Error: ' + data.detail, 'error');
            }
        } catch (e) {
            showToast('Upload failed', 'error');
        } finally {
            document.body.classList.remove('htmx-request');
            input.value = ''; // Reset
        }
    }

    async function loadRules() {
        const response = await fetch(`/api/compliance/rules?org=${orgId}&project=${projectId}`);
        const data = await response.json();

        const list = document.getElementById('rules-list');
        if (data.rules.length === 0) {
            list.innerHTML = '<p class="text-muted text-center">No rules loaded.</p>';
            return;
        }

        list.innerHTML = data.rules.map(r => `
            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                <div style="font-weight: 600;">${r.name}</div>
                <div style="font-size: 0.9em; color: #666;">${r.description}</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">
                    <code>${JSON.stringify(r.rule_logic)}</code>
                </div>
            </div>
        `).join('');
    }

    async function runCheck() {
        try {
            document.body.classList.add('htmx-request');
            const response = await fetch(`/api/compliance/check?org=${orgId}&project=${projectId}`, {
                method: 'POST'
            });
            const data = await response.json();

            if (response.ok) {
                showToast('Check complete!', 'success');
                updateStats(data.stats);
                loadResults();
            } else {
                showToast('Check failed: ' + data.detail, 'error');
            }
        } catch (e) {
            showToast('Check failed', 'error');
        } finally {
            document.body.classList.remove('htmx-request');
        }
    }

    function updateStats(stats) {
        document.getElementById('stat-total').textContent = stats.passed + stats.failed + stats.warnings;
        document.getElementById('stat-passed').textContent = stats.passed;
        document.getElementById('stat-failed').textContent = stats.failed;
        document.getElementById('stat-warnings').textContent = stats.warnings;
    }

    async function loadResults() {
        const response = await fetch(`/api/compliance/results?org=${orgId}&project=${projectId}`);
        const data = await response.json();

        const tbody = document.querySelector('#results-table tbody');
        if (data.results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No results found.</td></tr>';
            return;
        }

        tbody.innerHTML = data.results.map(r => `
            <tr>
                <td><span class="badge badge-${getStatusClass(r.status)}">${r.status.toUpperCase()}</span></td>
                <td>${r.item_name}</td>
                <td>${r.rule_name}</td>
                <td>${r.message}</td>
            </tr>
        `).join('');
    }

    function getStatusClass(status) {
        if (status === 'pass') return 'success';
        if (status === 'fail') return 'danger';
        return 'warning';
    }

    // Initial load
    loadRules();
    loadResults();
</script>
{% endblock %}