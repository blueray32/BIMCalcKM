{% extends "base.html" %}

{% block title %}Price Details - BIMCalc{% endblock %}

{% block content %}
<style>
    .current-price-row {
        background: #f0fff4;
    }
</style>
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1>{{ price.description }}</h1>
            <p style="color: #666;">{{ price.vendor_id or 'Unknown Vendor' }} | {{ price.item_code }}</p>
        </div>
        <a href="/prices?org={{ org_id }}&project={{ project_id }}" class="btn" style="text-decoration: none;">
            ‚Üê Back to Prices
        </a>
    </div>
</div>

<!-- Item Information -->
<div class="card">
    <div class="card-header">üì¶ Item Information</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Item
                    Code</label>
                <p style="font-size: 1.125rem; margin: 0; font-family: monospace;">{{ price.item_code }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">SKU</label>
                <p style="margin: 0; font-family: monospace;">{{ price.sku }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Vendor</label>
                <p style="margin: 0;">{{ price.vendor_id or "-" }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Vendor
                    Code</label>
                <p style="margin: 0;">{{ price.vendor_code or "-" }}</p>
            </div>
        </div>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">

        <div>
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Description</label>
            <p style="margin: 0; line-height: 1.6;">{{ price.description }}</p>
        </div>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div>
                <label
                    style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Classification</label>
                <p style="margin: 0;">
                    <span class="badge badge-info">{{ price.classification_code }}</span>
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Region</label>
                <p style="margin: 0;">
                    <span class="badge">{{ price.region }}</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Pricing -->
<div class="card">
    <div class="card-header">üí∞ Pricing</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Unit
                    Price</label>
                <p style="font-size: 2rem; margin: 0; font-weight: 700; color: #2d3748;">
                    {{ "%.2f"|format(price.unit_price) }} {{ price.currency }}
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Unit</label>
                <p style="font-size: 1.25rem; margin: 0;">{{ price.unit }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">VAT Rate</label>
                <p style="margin: 0;">{{ "%.1f"|format(price.vat_rate) if price.vat_rate else "-" }}%</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Currency</label>
                <p style="margin: 0;">{{ price.currency }}</p>
            </div>
        </div>

        {% if price.source_currency and price.source_currency != price.currency %}
        <div
            style="margin-top: 1rem; padding: 0.75rem; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 0.375rem;">
            <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
                <strong>Source Currency:</strong> {{ price.source_currency }}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Physical Attributes -->
<div class="card">
    <div class="card-header">üìê Physical Attributes</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Width</label>
                <p style="margin: 0;">{{ price.width_mm }}mm {% if not price.width_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Height</label>
                <p style="margin: 0;">{{ price.height_mm }}mm {% if not price.height_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">DN
                    (Diameter)</label>
                <p style="margin: 0;">{{ price.dn_mm }}mm {% if not price.dn_mm %}-{% endif %}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Angle</label>
                <p style="margin: 0;">{{ price.angle_deg }}¬∞ {% if not price.angle_deg %}-{% endif %}</p>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Material</label>
                <p style="margin: 0;">{{ price.material or "-" }}</p>
            </div>
        </div>
    </div>
</div>

<!-- SCD Type-2 Temporal Tracking -->
<div class="card">
    <div class="card-header">‚è±Ô∏è Price History (SCD Type-2)</div>
    <div style="padding: 1.5rem;">
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Valid
                    From</label>
                <p style="margin: 0;">{{ price.valid_from.strftime("%Y-%m-%d %H:%M") if price.valid_from else "-" }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Valid To</label>
                <p style="margin: 0;">
                    {% if price.valid_to %}
                    {{ price.valid_to.strftime("%Y-%m-%d %H:%M") }}
                    {% else %}
                    <span style="color: #48bb78; font-weight: 600;">Current</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Status</label>
                <p style="margin: 0;">
                    {% if price.is_current %}
                    <span class="badge badge-success">‚úì Current</span>
                    {% else %}
                    <span class="badge" style="background: #cbd5e0;">Historical</span>
                    {% endif %}
                </p>
            </div>
        </div>

        {% if price_history|length > 1 %}
        <div style="border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
            <h4 style="margin-bottom: 1rem; font-size: 1rem; color: #2d3748;">Price Change History</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                        <th style="padding: 0.75rem; text-align: left;">Period</th>
                        <th style="padding: 0.75rem; text-align: right;">Price</th>
                        <th style="padding: 0.75rem; text-align: right;">Change</th>
                        <th style="padding: 0.75rem; text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hist in price_history %}
                    <tr class="{% if hist.is_current %}current-price-row{% endif %}"
                        style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 0.75rem; font-size: 0.875rem;">
                            {{ hist.valid_from.strftime("%Y-%m-%d") if hist.valid_from else "?" }}
                            ‚Üí
                            {{ hist.valid_to.strftime("%Y-%m-%d") if hist.valid_to else "now" }}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                            {{ "%.2f"|format(hist.unit_price) }} {{ hist.currency }}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem;">
                            {% if loop.index < price_history|length %} {% set
                                change=(price_history[loop.index].unit_price - hist.unit_price) / hist.unit_price * 100
                                %} {% if change> 0 %}
                                <span style="color: #e53e3e;">+{{ "%.1f"|format(change) }}%</span>
                                {% elif change < 0 %} <span style="color: #48bb78;">{{ "%.1f"|format(change) }}%</span>
                                    {% else %}
                                    <span style="color: #718096;">0%</span>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            {% if hist.is_current %}
                            <span class="badge badge-success">Current</span>
                            {% else %}
                            <span class="badge" style="background: #e2e8f0;">Historical</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Source & Metadata -->
<div class="card">
    <div class="card-header">üìã Source & Metadata</div>
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Price ID</label>
                <p style="margin: 0;"><code style="font-size: 0.75rem;">{{ price.id }}</code></p>
            </div>
            <div>
                <label
                    style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Organization</label>
                <p style="margin: 0;">{{ price.org_id }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Source</label>
                <p style="margin: 0;">
                    <span class="badge" style="background: #edf2f7; color: #2d3748;">{{ price.source_name }}</span>
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Last
                    Updated</label>
                <p style="margin: 0;">{{ price.last_updated.strftime("%Y-%m-%d %H:%M:%S") if price.last_updated else "-"
                    }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Created
                    At</label>
                <p style="margin: 0;">{{ price.created_at.strftime("%Y-%m-%d %H:%M:%S") if price.created_at else "-" }}
                </p>
            </div>
            {% if price.original_effective_date %}
            <div>
                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Original
                    Effective Date</label>
                <p style="margin: 0;">{{ price.original_effective_date.strftime("%Y-%m-%d") }}</p>
            </div>
            {% endif %}
        </div>

        {% if price.vendor_note %}
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 0.375rem;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">Vendor Note</label>
            <p style="margin: 0; color: #4a5568;">{{ price.vendor_note }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Actions -->
<div class="card">
    <div class="card-header">‚ö° Actions</div>
    <div style="padding: 1.5rem; display: flex; gap: 0.75rem;">
        <a href="/prices?org={{ org_id }}&project={{ project_id }}" class="btn" style="text-decoration: none;">
            ‚Üê Back to Prices List
        </a>
        <a href="/prices?org={{ org_id }}&project={{ project_id }}&current_only=false&search={{ price.item_code }}"
            class="btn btn-primary" style="text-decoration: none;">
            View Price History
        </a>
    </div>
</div>

{% endblock %}