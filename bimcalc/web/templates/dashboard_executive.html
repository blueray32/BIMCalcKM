{% extends "base.html" %}

{% block title %}Executive Dashboard - BIMCalc{% endblock %}

{% block extra_styles %}
<style>
    /* Executive Dashboard Theme - Purple/Indigo */
    .executive-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .health-indicator {
        text-align: center;
        margin: 2rem 0;
    }

    .health-ring-container {
        position: relative;
        display: inline-block;
        margin: 0 auto;
    }

    .health-ring {
        transform: rotate(-90deg);
    }

    .health-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .health-number {
        font-size: 3rem;
        font-weight: 700;
        line-height: 1;
    }

    .health-label {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.5rem;
        font-weight: 600;
    }

    .health-status {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1rem;
    }

    .health-status.excellent {
        color: #48bb78;
    }

    .health-status.good {
        color: #4299e1;
    }

    .health-status.fair {
        color: #ed8936;
    }

    .health-status.poor {
        color: #f56565;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        border-left: 4px solid #667eea;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-card.financial {
        border-left-color: #48bb78;
    }

    .metric-card.review {
        border-left-color: #f56565;
    }

    .metric-card.progress {
        border-left-color: #4299e1;
    }

    .metric-card.activity {
        border-left-color: #9f7aea;
    }

    .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }

    .metric-subtitle {
        font-size: 0.875rem;
        color: #a0aec0;
    }

    .metric-trend {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .metric-trend.up {
        color: #48bb78;
    }

    .metric-trend.down {
        color: #f56565;
    }

    .metric-trend.neutral {
        color: #a0aec0;
    }

    .activity-feed {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }

    .activity-time {
        font-size: 0.75rem;
        color: #a0aec0;
    }

    .quick-nav {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .nav-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(102, 126, 234, 0.2);
    }

    .nav-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(102, 126, 234, 0.3);
    }

    .nav-card.progress {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    }

    .nav-card.review {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }

    .nav-card.reports {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }

    .nav-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .nav-label {
        font-weight: 600;
        font-size: 1.125rem;
    }

    .alert-banner {
        background: #fff5f5;
        border-left: 4px solid #f56565;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .alert-banner.warning {
        background: #fffaf0;
        border-left-color: #ed8936;
    }

    .alert-banner.info {
        background: #ebf8ff;
        border-left-color: #4299e1;
    }

    .chart-container {
        position: relative;
        height: 250px;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Executive Header -->
<div class="executive-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
            <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem;">üìä Executive Dashboard</h1>
            <p style="margin: 0; opacity: 0.9;">Project command center for {{ project_id }} in {{ org_id }}</p>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.8; font-size: 0.875rem;">
                <span id="exec-last-updated">Last updated: just now</span>
            </p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="exportToExcel()" class="btn btn-primary"
                style="display: inline-flex; align-items: center; gap: 0.5rem;">
                <span>üì•</span>
                <span>Export Excel</span>
            </button>
            <button onclick="exportToPdf()" class="btn"
                style="display: inline-flex; align-items: center; gap: 0.5rem; background: #e53e3e; color: white; margin-left: 0.5rem;">
                <span>üìÑ</span>
                <span>Export PDF</span>
            </button>
            <button onclick="location.reload()"
                style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; backdrop-filter: blur(10px); cursor: pointer;">
                <span>üîÑ</span>
                <span>Refresh</span>
            </button>
            <a href="/?org={{ org_id }}&project={{ project_id }}"
                style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; backdrop-filter: blur(10px);">
                <span>‚Üê</span>
                <span>Standard View</span>
            </a>
        </div>
    </div>
</div>

<script>
    // Update timestamp every 60 seconds
    const execStartTime = new Date();
    setInterval(() => {
        const elapsed = Math.floor((new Date() - execStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        async function exportToPdf() {
            const btn = event.currentTarget;
            const originalContent = btn.innerHTML;

            try {
                btn.innerHTML = `
                <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>Generating...</span>
            `;
                btn.disabled = true;

                const response = await fetch(`/api/projects/${projectId}/export/pdf`);

                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Get filename from header or default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'project_report.pdf';
                if (contentDisposition) {
                    const matches = /filename="([^"]*)"/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1];
                    }
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to generate PDF report. Please try again.');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
        let timeStr = 'just now';
        if (minutes > 0) {
            timeStr = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else if (seconds > 10) {
            timeStr = `${seconds} seconds ago`;
        }

        document.getElementById('exec-last-updated').textContent = `Last updated: ${timeStr}`;
    }, 1000);

    async function exportToExcel() {
        const btn = document.querySelector('button[onclick="exportToExcel()"]');
        const originalText = btn.innerHTML;

        try {
            btn.innerHTML = '<span>‚è≥</span><span>Exporting...</span>';
            btn.disabled = true;

            // Get project ID from URL or template context
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = "{{ project_id }}"; // Use template variable directly

            // Fetch the file
            const response = await fetch(`/api/projects/${projectId}/export/excel`);

            if (!response.ok) {
                throw new Error('Export failed');
            }

            // Create blob and download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Get filename from header or default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'project_costs.xlsx';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        } catch (error) {
            console.error('Export error:', error);
            alert('Failed to export Excel file. Please try again.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>

<!-- Executive Navigation -->
{% set current_page = 'dashboard' %}
{% set pending_count = metrics.total_pending_review %}
{% include 'executive_nav.html' %}

<!-- Alert Banners -->
{% if metrics.high_urgency_count > 0 %}
<div class="alert-banner">
    <div style="font-size: 1.5rem;">üö®</div>
    <div style="flex: 1;">
        <strong>Critical Items Require Attention</strong><br>
        <span style="font-size: 0.875rem;">{{ metrics.high_urgency_count }} items with critical flags need
            review.</span>
    </div>
    <a href="/review?org={{ org_id }}&project={{ project_id }}&severity=Critical-Veto"
        style="background: #f56565; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; text-decoration: none; font-weight: 600; white-space: nowrap;">
        Review Now
    </a>
</div>
{% elif metrics.total_pending_review > metrics.total_items * 0.2 %}
<div class="alert-banner warning">
    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
    <div style="flex: 1;">
        <strong>Review Queue Building</strong><br>
        <span style="font-size: 0.875rem;">{{ metrics.total_pending_review }} items pending review ({{
            "%.1f"|format((metrics.total_pending_review / metrics.total_items * 100) if metrics.total_items > 0 else 0)
            }}% of total).</span>
    </div>
    <a href="/review?org={{ org_id }}&project={{ project_id }}"
        style="background: #ed8936; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; text-decoration: none; font-weight: 600; white-space: nowrap;">
        Review Queue
    </a>
</div>
{% elif metrics.match_percentage < 50 %} <div class="alert-banner info">
    <div style="font-size: 1.5rem;">‚ÑπÔ∏è</div>
    <div style="flex: 1;">
        <strong>Low Match Coverage</strong><br>
        <span style="font-size: 0.875rem;">Only {{ "%.1f"|format(metrics.match_percentage) }}% of items have price
            matches. Consider running the matching pipeline.</span>
    </div>
    <a href="/match?org={{ org_id }}&project={{ project_id }}"
        style="background: #4299e1; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; text-decoration: none; font-weight: 600; white-space: nowrap;">
        Run Matching
    </a>
    </div>
    {% endif %}

    <!-- Health Score -->
    <div class="card" style="text-align: center;">
        <div class="health-indicator">
            <div class="health-ring-container">
                <svg class="health-ring" width="240" height="240">
                    <circle cx="120" cy="120" r="100" fill="none" stroke="#e2e8f0" stroke-width="20"></circle>
                    <circle cx="120" cy="120" r="100" fill="none"
                        stroke="{% if metrics.health_score >= 85 %}#48bb78{% elif metrics.health_score >= 70 %}#4299e1{% elif metrics.health_score >= 50 %}#ed8936{% else %}#f56565{% endif %}"
                        stroke-width="20" stroke-dasharray="628"
                        stroke-dashoffset="{{ 628 - (628 * (metrics.health_score / 100)) }}" stroke-linecap="round"
                        style="transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);"></circle>
                </svg>
                <div class="health-value">
                    <div class="health-number">{{ metrics.health_score }}</div>
                    <div class="health-label">Health Score</div>
                </div>
            </div>
            <div class="health-status {{ metrics.health_status.lower() }}">
                {% if metrics.health_status == "Excellent" %}‚ú® Excellent
                {% elif metrics.health_status == "Good" %}‚úì Good
                {% elif metrics.health_status == "Fair" %}‚ö° Fair
                {% else %}‚ö† Needs Attention{% endif %}
            </div>
        </div>
    </div>

    <!-- Key Metrics Grid -->
    {% set _total_cost_net = metrics.total_cost_net %}
    {% set high_risk_ratio = (metrics.high_risk_cost / _total_cost_net) if _total_cost_net else 0 %}
    <div class="metrics-grid">
        <!-- Financial Metric -->
        <div class="metric-card financial">
            <div class="metric-icon">üí∞</div>
            <div class="metric-label">Total Installed Cost</div>
            <div class="metric-value">‚Ç¨{{ "{:,.0f}".format(metrics.total_installed_cost) }}</div>
            <div class="metric-subtitle">Mat: ‚Ç¨{{ "{:,.0f}".format(metrics.total_cost_net) }} | Lab: ‚Ç¨{{
                "{:,.0f}".format(metrics.total_labor_cost) }}</div>
            <div class="metric-trend neutral">
                <span>üë∑</span>
                <span>{{ "{:,.0f}".format(metrics.total_labor_hours) }} hours @ ‚Ç¨{{ metrics.blended_labor_rate
                    }}/hr</span>
            </div>
        </div>

        <!-- Review Queue Metric -->
        <div class="metric-card review">
            <div class="metric-icon">üîç</div>
            <div class="metric-label">Review Queue</div>
            <div class="metric-value">{{ metrics.total_pending_review }}</div>
            <div class="metric-subtitle">
                {% if metrics.high_urgency_count > 0 %}
                {{ metrics.high_urgency_count }} critical, {{ metrics.advisory_count }} advisory
                {% else %}
                {{ metrics.advisory_count }} advisory items
                {% endif %}
            </div>
            <div
                class="metric-trend {% if metrics.total_pending_review == 0 %}up{% elif metrics.total_pending_review > metrics.total_items * 0.1 %}down{% else %}neutral{% endif %}">
                {% if metrics.total_pending_review == 0 %}
                <span>‚úì</span> <span>All clear</span>
                {% else %}
                <span>‚è≥</span> <span>{{ "%.1f"|format((metrics.total_pending_review / metrics.total_items * 100) if
                    metrics.total_items > 0 else 0) }}% of items</span>
                {% endif %}
            </div>
        </div>

        <!-- Match Progress Metric -->
        <div class="metric-card progress">
            <div class="metric-icon">üéØ</div>
            <div class="metric-label">Match Coverage</div>
            <div class="metric-value">{{ "%.1f"|format(metrics.match_percentage) }}%</div>
            <div class="metric-subtitle">{{ metrics.matched_items }} of {{ metrics.total_items }} items</div>
            <div
                class="metric-trend {% if metrics.match_percentage >= 90 %}up{% elif metrics.match_percentage >= 70 %}neutral{% else %}down{% endif %}">
                <span>ü§ñ</span>
                <span>{{ "%.1f"|format(metrics.auto_approval_rate) }}% auto-approved</span>
            </div>
        </div>

        <!-- Quality Metric -->
        <div class="metric-card quality">
            <div class="metric-icon">‚ú®</div>
            <div class="metric-label">Match Quality</div>
            <div class="metric-value">
                {% if metrics.avg_confidence %}{{ "%.0f"|format(metrics.avg_confidence * 100) }}%{% else %}-{% endif %}
            </div>
            <div class="metric-subtitle">Avg Confidence</div>
            {% if metrics.high_confidence_percentage >= 80 %}
            <div class="trend-indicator positive">High Trust</div>
            {% else %}
            <div class="trend-indicator negative">Needs Review</div>
            {% endif %}
        </div>

        <!-- Risk Profile Metric -->
        <div class="metric-card" style="border-top: 4px solid #805ad5;">
            <div class="metric-icon">üõ°Ô∏è</div>
            <div class="metric-label">Risk Profile</div>
            <div class="metric-value">{{ "%.0f"|format(metrics.avg_risk_score) }}</div>
            <div class="metric-subtitle">Avg Risk Score</div>

            {% set total_risk = metrics.risk_distribution.High + metrics.risk_distribution.Medium +
            metrics.risk_distribution.Low %}
            <div
                style="margin-top: 1rem; display: flex; gap: 2px; height: 8px; border-radius: 4px; overflow: hidden; background: #edf2f7;">
                {% if total_risk > 0 %}
                <div style="--risk-high: {{ metrics.risk_distribution.High }}; flex: var(--risk-high); background: #f56565;"
                    title="High Risk: {{ metrics.risk_distribution.High }}"></div>
                <div style="--risk-med: {{ metrics.risk_distribution.Medium }}; flex: var(--risk-med); background: #ed8936;"
                    title="Medium Risk: {{ metrics.risk_distribution.Medium }}"></div>
                <div style="--risk-low: {{ metrics.risk_distribution.Low }}; flex: var(--risk-low); background: #48bb78;"
                    title="Low Risk: {{ metrics.risk_distribution.Low }}"></div>
                {% else %}
                <div style="flex: 1; background: #edf2f7;"></div>
                {% endif %}
            </div>
            <div
                style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #718096; margin-top: 0.25rem;">
                <span style="color: #f56565; font-weight: 600;">{{ metrics.risk_distribution.High }} High</span>
                <span style="color: #48bb78;">{{ metrics.risk_distribution.Low }} Low</span>
            </div>
        </div>
    </div>

    {% if metrics.classification_distribution %}
    <div class="card">
        <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.25rem;">üè∑Ô∏è Classification Distribution</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
                <div class="chart-container" style="min-height: 280px;">
                    <canvas id="classificationChart"></canvas>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for cls in metrics.classification_distribution %}
                <div
                    style="display: flex; gap: 1rem; align-items: center; padding: 0.75rem; background: #f7fafc; border-radius: 0.75rem;">
                    <div
                        style="min-width: 64px; text-align: center; font-weight: 700; color: #4a5568; font-size: 1rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem; background: #edf2f7;">
                        {{ cls.code }}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #2d3748;">{{ cls.name }}</div>
                        <div style="font-size: 0.875rem; color: #718096; margin-top: 0.25rem;">
                            {{ cls.items }} items ¬∑ {{ cls.matched }} matched ¬∑ {{ metrics.currency }} {{
                            "{:,.0f}".format(cls.matched_cost) }}
                        </div>
                        <div style="font-size: 0.75rem; color: #a0aec0; margin-top: 0.25rem;">
                            {{ "%.1f"|format(cls.cost_share) }}% of spend{% if cls.avg_confidence %} ¬∑ Avg confidence {{
                            "%.1f"|format(cls.avg_confidence) }}%{% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- High Risk Items (Loaded via API) -->
    <div class="card" id="highRiskContainer" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">‚ö†Ô∏è High Risk Items</h3>
            <span class="badge" style="background: #fed7d7; color: #c53030;" id="highRiskCount">0 items</span>
        </div>
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #e2e8f0; text-align: left;">
                        <th style="padding: 0.75rem; color: #4a5568; font-size: 0.875rem;">Item</th>
                        <th style="padding: 0.75rem; color: #4a5568; font-size: 0.875rem;">Risk Score</th>
                        <th style="padding: 0.75rem; color: #4a5568; font-size: 0.875rem;">Primary Factors</th>
                        <th style="padding: 0.75rem; color: #4a5568; font-size: 0.875rem;">Action</th>
                    </tr>
                </thead>
                <tbody id="highRiskTableBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recommendations (Loaded via API) -->
    <div class="card" id="recommendationsContainer"
        style="display: none; margin-top: 1.5rem; border-left: 4px solid #4299e1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">üí° Intelligence Recommendations</h3>
            <span class="badge" style="background: #ebf8ff; color: #2b6cb0;" id="recommendationCount">0 insights</span>
        </div>
        <div id="recommendationsList"
            style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Compliance Status (Loaded via API) -->
    <div class="card" id="complianceContainer"
        style="display: none; margin-top: 1.5rem; border-left: 4px solid #ed8936;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">üìã Compliance Status</h3>
                <button onclick="openRulesModal()"
                    style="background: #edf2f7; border: none; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; color: #4a5568; cursor: pointer; font-weight: 600;">‚öôÔ∏è
                    Configure Rules</button>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #2d3748;" id="complianceScore">--%</div>
                <div style="font-size: 0.75rem; color: #718096;">Compliance Score</div>
            </div>
        </div>

        <div id="complianceFailures" style="display: none;">
            <h4 style="margin: 0 0 0.5rem 0; color: #e53e3e; font-size: 0.875rem;">Non-Compliant Items</h4>
            <div class="table-container">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e2e8f0; text-align: left;">
                            <th style="padding: 0.5rem; color: #4a5568; font-size: 0.75rem;">Item</th>
                            <th style="padding: 0.5rem; color: #4a5568; font-size: 0.75rem;">Issues</th>
                            <th style="padding: 0.5rem; color: #4a5568; font-size: 0.75rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="complianceTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="complianceSuccess" style="display: none; text-align: center; padding: 1rem; color: #48bb78;">
            <div style="font-size: 2rem;">‚úÖ</div>
            <div style="font-weight: 600;">All items are compliant!</div>
        </div>
    </div>

    <!-- Rules Configuration Modal -->
    <div id="rulesModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: white; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 80vh;">
            <div
                style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #2d3748;">Compliance Rules</h3>
                <button onclick="closeRulesModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 1rem; overflow-y: auto; flex: 1;">
                <div id="rulesList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div
                style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right; background: #f7fafc; border-radius: 0 0 0.5rem 0.5rem;">
                <button onclick="closeRulesModal()"
                    style="background: #cbd5e0; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; color: #2d3748; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Modal Functions
        function openRulesModal() {
            document.getElementById('rulesModal').style.display = 'flex';
            loadRules();
        }

        function closeRulesModal() {
            document.getElementById('rulesModal').style.display = 'none';
        }

        async function loadRules() {
            const projectId = "{{ project_id }}";
            const list = document.getElementById('rulesList');
            list.innerHTML = '<div style="text-align: center; padding: 2rem; color: #718096;">Loading rules...</div>';

            try {
                const response = await fetch(`/api/projects/${projectId}/intelligence/rules`);
                if (response.ok) {
                    const data = await response.json();
                    list.innerHTML = data.rules.map(rule => `
                        <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: ${rule.is_active ? '#fff' : '#f7fafc'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748; ${!rule.is_active ? 'text-decoration: line-through; color: #a0aec0;' : ''}">${rule.name}</div>
                                    <div style="font-size: 0.875rem; color: #718096;">${rule.description}</div>
                                </div>
                                <label class="switch" style="position: relative; display: inline-block; width: 40px; height: 24px;">
                                    <input type="checkbox" ${rule.is_active ? 'checked' : ''} onchange="toggleRule('${rule.id}', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                    <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e0; transition: .4s; border-radius: 24px;"></span>
                                    <span class="knob" style="position: absolute; content: ''; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </label>
                            </div>
                            ${rule.rule_type === 'vendor_whitelist' ? `
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #edf2f7;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #4a5568; margin-bottom: 0.25rem;">Allowed Vendors:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${rule.configuration.vendors.map(v => `<span style="background: #ebf8ff; color: #2b6cb0; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">${v}</span>`).join('')}
                                        <button onclick="editVendorList('${rule.id}')" style="background: none; border: none; color: #4299e1; font-size: 0.75rem; cursor: pointer; text-decoration: underline;">Edit</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    // Add CSS for switch if not present
                    if (!document.getElementById('switch-style')) {
                        const style = document.createElement('style');
                        style.id = 'switch-style';
                        style.textContent = `
                            input:checked + .slider { background-color: #4299e1; }
                            input:focus + .slider { box-shadow: 0 0 1px #4299e1; }
                            input:checked + .slider .knob { transform: translateX(16px); }
                        `;
                        document.head.appendChild(style);
                    }
                }
            } catch (e) {
                console.error("Failed to load rules", e);
                list.innerHTML = '<div style="color: #e53e3e; text-align: center;">Failed to load rules.</div>';
            }
        }

        async function toggleRule(ruleId, isActive) {
            const projectId = "{{ project_id }}";
            try {
                await fetch(`/api/projects/${projectId}/intelligence/rules/${ruleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                // Reload compliance status in background
                location.reload(); // Simple reload for now to refresh everything
            } catch (e) {
                console.error("Failed to update rule", e);
                alert("Failed to update rule status");
            }
        }

        async function editVendorList(ruleId) {
            const vendors = prompt("Enter allowed vendors (comma separated):");
            if (vendors !== null) {
                const vendorList = vendors.split(',').map(v => v.trim()).filter(v => v);
                const projectId = "{{ project_id }}";
                try {
                    await fetch(`/api/projects/${projectId}/intelligence/rules/${ruleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ configuration: { vendors: vendorList } })
                    });
                    loadRules(); // Reload list
                } catch (e) {
                    console.error("Failed to update vendors", e);
                    alert("Failed to update vendor list");
                }
            }
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const projectId = "{{ project_id }}";

            // Load High Risk Items
            try {
                const response = await fetch(`/api/projects/${projectId}/intelligence/risk`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.high_risk_items && data.high_risk_items.length > 0) {
                        const container = document.getElementById('highRiskContainer');
                        const tbody = document.getElementById('highRiskTableBody');
                        const countBadge = document.getElementById('highRiskCount');

                        container.style.display = 'block';
                        countBadge.textContent = `${data.summary.high} items`;

                        tbody.innerHTML = data.high_risk_items.map(item => {
                            const factors = Object.entries(item.factors)
                                .map(([k, v]) => `<span class="badge" style="background: #edf2f7; color: #4a5568; font-size: 0.75rem; margin-right: 4px;">${v}</span>`)
                                .join('');

                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0;">
                                    <td style="padding: 0.75rem;">
                                        <div style="font-weight: 600; color: #2d3748;">${item.family}</div>
                                        <div style="font-size: 0.75rem; color: #718096;">${item.type}</div>
                                    </td>
                                    <td style="padding: 0.75rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 40px; height: 4px; background: #e2e8f0; border-radius: 2px;">
                                                <div style="width: ${item.score}%; height: 100%; background: #f56565; border-radius: 2px;"></div>
                                            </div>
                                            <span style="font-weight: 700; color: #f56565;">${Math.round(item.score)}</span>
                                        </div>
                                    </td>
                                    <td style="padding: 0.75rem;">${factors}</td>
                                    <td style="padding: 0.75rem;">
                                        <a href="/items/${item.item_id}" style="color: #4299e1; text-decoration: none; font-weight: 600; font-size: 0.875rem;">Review &rarr;</a>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error("Failed to load risk data", e);
            }

            // Load Recommendations
            try {
                const response = await fetch(`/api/projects/${projectId}/intelligence/recommendations`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.recommendations && data.recommendations.length > 0) {
                        const container = document.getElementById('recommendationsContainer');
                        const list = document.getElementById('recommendationsList');
                        const countBadge = document.getElementById('recommendationCount');

                        container.style.display = 'block';
                        countBadge.textContent = `${data.recommendations.length} insights`;

                        list.innerHTML = data.recommendations.map(rec => {
                            let icon = 'üí°';
                            let color = '#4299e1';
                            let bg = '#ebf8ff';

                            if (rec.type === 'data_quality') { icon = 'üìù'; color = '#ed8936'; bg = '#ffebd8'; }
                            if (rec.type === 'cost_saving') { icon = 'üí∞'; color = '#48bb78'; bg = '#f0fff4'; }

                            return `
                                <div style="padding: 1rem; background: #f7fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; display: flex; gap: 1rem;">
                                    <div style="font-size: 1.5rem; background: ${bg}; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0;">${icon}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.25rem;">${rec.message}</div>
                                        ${rec.potential_saving ? `<div style="font-size: 0.875rem; color: #48bb78; font-weight: 600; margin-bottom: 0.5rem;">Potential Saving: ‚Ç¨${rec.potential_saving.toFixed(2)}</div>` : ''}
                                        <a href="${rec.action_url}" style="display: inline-block; font-size: 0.875rem; color: ${color}; font-weight: 600; text-decoration: none; margin-top: 0.25rem;">${rec.action_label} &rarr;</a>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error("Failed to load recommendations", e);
            }

            // Load Compliance
            try {
                const response = await fetch(`/api/projects/${projectId}/intelligence/compliance`);
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('complianceContainer');
                    const scoreEl = document.getElementById('complianceScore');
                    const failuresDiv = document.getElementById('complianceFailures');
                    const successDiv = document.getElementById('complianceSuccess');
                    const tbody = document.getElementById('complianceTableBody');

                    container.style.display = 'block';
                    scoreEl.textContent = `${Math.round(data.summary.score)}%`;

                    if (data.summary.score < 100) {
                        scoreEl.style.color = '#e53e3e';
                        failuresDiv.style.display = 'block';
                        successDiv.style.display = 'none';

                        tbody.innerHTML = data.failures.map(item => {
                            const issues = item.issues.map(i => `<div style="color: #e53e3e; font-size: 0.75rem;">‚Ä¢ ${i}</div>`).join('');
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0;">
                                    <td style="padding: 0.5rem;">
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #2d3748;">${item.family}</div>
                                    </td>
                                    <td style="padding: 0.5rem;">${issues}</td>
                                    <td style="padding: 0.5rem;">
                                        <a href="/items/${item.item_id}" style="color: #4299e1; text-decoration: none; font-weight: 600; font-size: 0.75rem;">Fix</a>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        scoreEl.style.color = '#48bb78';
                        failuresDiv.style.display = 'none';
                        successDiv.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("Failed to load compliance", e);
            }
        });
    </script>

    <!-- Recent Activity & Charts Row -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Recent Activity Feed -->
        <div class="activity-feed">
            <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.25rem;">üìà Recent Activity (7 Days)</h3>

            {% if metrics.recent_matches > 0 or metrics.recent_approvals > 0 or metrics.recent_ingestions > 0 %}
            <div class="activity-item">
                <div class="activity-icon">üîç</div>
                <div class="activity-content">
                    <div class="activity-title">{{ metrics.recent_matches }} Matches Processed</div>
                    <div class="activity-time">Matching pipeline activity</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon">‚úÖ</div>
                <div class="activity-content">
                    <div class="activity-title">{{ metrics.recent_approvals }} Items Approved</div>
                    <div class="activity-time">Manual and auto-approved matches</div>
                </div>
            </div>

            <div class="activity-item">
                <div class="activity-icon">üì§</div>
                <div class="activity-content">
                    <div class="activity-title">{{ metrics.recent_ingestions }} Items Ingested</div>
                    <div class="activity-time">Schedule uploads and imports</div>
                </div>
            </div>

            {% if metrics.recent_matches == 0 and metrics.recent_approvals == 0 and metrics.recent_ingestions == 0 %}
            <div style="text-align: center; padding: 2rem; color: #a0aec0;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí§</div>
                <div>No recent activity in the last 7 days</div>
            </div>
            {% endif %}

            {% else %}
            <div style="text-align: center; padding: 2rem; color: #a0aec0;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí§</div>
                <div>No recent activity in the last 7 days</div>
            </div>
            {% endif %}
        </div>

        <!-- Progress Chart -->
        <div class="card">
            <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.25rem;">üìä Project Progress</h3>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Navigation to Executive Views -->
    <div class="card">
        <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.25rem;">üöÄ Quick Navigation</h3>
        <div class="quick-nav">
            <a href="/progress?org={{ org_id }}&project={{ project_id }}&view=executive" class="nav-card progress">
                <div class="nav-icon">üéØ</div>
                <div class="nav-label">Match Progress</div>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">Pipeline status & trends</div>
            </a>

            <a href="/review?org={{ org_id }}&project={{ project_id }}&view=executive" class="nav-card review">
                <div class="nav-icon">üîç</div>
                <div class="nav-label">Review Queue</div>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">{{ metrics.total_pending_review }}
                    items pending</div>
            </a>

            <a href="/reports?org={{ org_id }}&project={{ project_id }}&view=executive" class="nav-card reports">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">Financial Summary</div>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">Cost analysis & reporting</div>
            </a>

            <a href="/audit?org={{ org_id }}&project={{ project_id }}" class="nav-card">
                <div class="nav-icon">üìú</div>
                <div class="nav-label">Audit Trail</div>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">Decision history & compliance</div>
            </a>
        </div>
    </div>

    <!-- Health Score Breakdown -->
    <div class="card">
        <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.25rem;">‚ÑπÔ∏è Health Score Calculation</h3>
        <div style="line-height: 1.8;">
            <p>The health score (0-100) is calculated using a weighted formula:</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li><strong>40%</strong> - Match Coverage ({{ "%.1f"|format(metrics.match_percentage) }}%)</li>
                <li><strong>30%</strong> - High Confidence Quality ({{ "%.1f"|format(metrics.high_confidence_percentage)
                    }}%)</li>
                <li><strong>20%</strong> - Auto-Approval Efficiency ({{ "%.1f"|format(metrics.auto_approval_rate) }}%)
                </li>
                <li><strong>10%</strong> - Review Queue Health ({{ metrics.total_pending_review }} pending)</li>
            </ul>
            <p style="margin-top: 1rem;"><strong>Penalties applied:</strong></p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li>-20 points if critical items > 10% of total</li>
                <li>-10 points if pending review > 25% of total</li>
            </ul>
            <p style="margin-top: 1rem;"><strong>Score Ranges:</strong></p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li><span class="health-status excellent">85-100:</span> Excellent - Project running smoothly</li>
                <li><span class="health-status good">70-84:</span> Good - Minor attention needed</li>
                <li><span class="health-status fair">50-69:</span> Fair - Review queue or quality issues</li>
                <li><span class="health-status poor">0-49:</span> Poor - Immediate action required</li>
            </ul>
        </div>
    </div>

    {% endblock %}

    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Progress breakdown chart
        const progressCtx = document.getElementById('progressChart');
        new Chart(progressCtx, {
            type: 'doughnut',
            data: {
                labels: ['Matched', 'Pending Review', 'Unmatched'],
                datasets: [{
                    data: [
                        Number('{{ metrics.matched_items - metrics.total_pending_review }}'),
                        Number('{{ metrics.total_pending_review }}'),
                        Number('{{ metrics.total_items - metrics.matched_items }}')
                    ],
                    backgroundColor: [
                        'rgba(72, 187, 120, 0.9)',
                        'rgba(237, 137, 54, 0.9)',
                        'rgba(203, 213, 224, 0.9)'
                    ],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 12, weight: '600' },
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 32, 44, 0.95)',
                        padding: 12,
                        callbacks: {
                            label: function (context) {
                                const total = Number('{{ metrics.total_items }}');
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return context.label + ': ' + context.parsed + ' items (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    </script>

    {% if metrics.classification_distribution %}
    <div id="classification-data" style="display:none;">
        {
        "labels": [{% for cls in metrics.classification_distribution %}{{ cls.code | tojson }}{% if not loop.last %}, {%
        endif %}{% endfor %}],
        "data": [{% for cls in metrics.classification_distribution %}{{ "%.2f"| format(cls.cost_share) }}{% if not
        loop.last %}, {% endif %}{% endfor %}],
        "spend": [{% for cls in metrics.classification_distribution %}{{ "%.0f" | format(cls.matched_cost) }}{% if not
        loop.last %}, {% endif %}{% endfor %}]
        }
    </div>
    <script>
        const chartData = JSON.parse(document.getElementById('classification-data').textContent);
        const classificationCtx = document.getElementById('classificationChart');
        new Chart(classificationCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    data: chartData.data, backgroundColor: [
                        'rgba(102, 126, 234, 0.9)',
                        'rgba(72, 187, 120, 0.9)',
                        'rgba(237, 137, 54, 0.9)',
                        'rgba(45, 55, 72, 0.7)',
                        'rgba(129, 140, 248, 0.9)',
                        'rgba(251, 113, 133, 0.9)'
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 12, weight: '600' }, padding: 15 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 32, 44, 0.95)',
                        padding: 12,
                        callbacks: {
                            label: function (context) {
                                const spend = chartData.spend[context.dataIndex];
                                return context.label + ': ' + context.parsed.toFixed(1) + '% ¬∑ {{ metrics.currency }} ' + Number(spend).toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    </script>
    {% endif %}


    <!-- Export to Excel -->
    {% set export_type = 'dashboard' %}
    {% include 'executive_export_button.html' %}

    <!-- Print/PDF Export -->
    {% include 'executive_print.html' %}

    {% endblock %}