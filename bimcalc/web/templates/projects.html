{% extends "base.html" %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>üìÅ Project Management</h1>
        <button onclick="showCreateForm()"
            style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            + New Project
        </button>
    </div>

    <!-- Create Project Form (Hidden initially) -->
    <div id="create-form"
        style="display: none; background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>Create New Project</h2>
        <form id="project-form" onsubmit="createProject(event)" style="display: grid; gap: 15px; max-width: 600px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Organization ID *</label>
                <input type="text" name="org_id" required
                    style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                    placeholder="e.g., company-name">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Project ID *</label>
                <input type="text" name="project_id" required
                    style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                    placeholder="e.g., project-2025">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Display Name *</label>
                <input type="text" name="display_name" required
                    style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                    placeholder="e.g., Office Building 2025">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                <textarea name="description" rows="3"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                    placeholder="Optional description..."></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Start Date</label>
                    <input type="date" name="start_date"
                        style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Target Completion</label>
                    <input type="date" name="target_completion"
                        style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit"
                    style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Create Project
                </button>
                <button type="button" onclick="hideCreateForm()"
                    style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loading" style="text-align: center; padding: 40px;">
        <p>Loading projects...</p>
    </div>

    <!-- Projects List -->
    <div id="projects-list" style="display: none;">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<style>
    .project-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: box-shadow 0.2s;
    }

    .project-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
    }

    .project-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a365d;
    }

    .project-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }

    .meta-item {
        font-size: 14px;
    }

    .meta-label {
        color: #718096;
        font-weight: 500;
        display: block;
        margin-bottom: 4px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    .status-archived {
        background: #e5e7eb;
        color: #374151;
    }

    .item-count {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
    }
</style>

<script>
    let projects = [];

    // Load projects on page load
    document.addEventListener('DOMContentLoaded', loadProjects);

    async function loadProjects() {
        try {
            const response = await fetch('/api/projects/all');
            const data = await response.json();
            projects = data.projects;

            renderProjects();
        } catch (error) {
            console.error('Failed to load projects:', error);
            document.getElementById('loading').innerHTML = '<p style="color: #dc2626;">Failed to load projects</p>';
        }
    }

    function renderProjects() {
        const container = document.getElementById('projects-list');
        const loading = document.getElementById('loading');

        if (projects.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #718096;">
                    <p style="font-size: 18px; margin-bottom: 10px;">No projects yet</p>
                    <p>Click "New Project" to create your first project</p>
                </div>
            `;
        } else {
            container.innerHTML = projects.map(proj => `
                <div class="project-card">
                    <div class="project-header">
                        <div>
                            <div class="project-title">${proj.display_name}</div>
                            <div style="color: #718096; font-size: 14px; margin-top: 4px;">
                                ${proj.org_id} / ${proj.project_id}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="status-badge status-${proj.status}">${proj.status}</span>
                            <span class="item-count">${proj.item_count} items</span>
                            <button onclick="deleteProject('${proj.id}')" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                Delete
                            </button>
                        </div>
                    </div>

                    ${proj.description ? `<p style="color: #4a5568; margin: 10px 0;">${proj.description}</p>` : ''}

                    <div class="project-meta">
                        ${proj.start_date ? `
                            <div class="meta-item">
                                <span class="meta-label">Start Date</span>
                                <span>${new Date(proj.start_date).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                        
                        ${proj.target_completion ? `
                            <div class="meta-item">
                                <span class="meta-label">Target Completion</span>
                                <span>${new Date(proj.target_completion).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                        
                        <div class="meta-item">
                            <span class="meta-label">Created</span>
                            <span>${new Date(proj.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        loading.style.display = 'none';
        container.style.display = 'block';
    }

    function showCreateForm() {
        document.getElementById('create-form').style.display = 'block';
        document.getElementById('project-form').reset();
    }

    function hideCreateForm() {
        document.getElementById('create-form').style.display = 'none';
    }

    async function createProject(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        const projectData = {
            org_id: formData.get('org_id'),
            project_id: formData.get('project_id'),
            display_name: formData.get('display_name'),
            description: formData.get('description') || null,
            start_date: formData.get('start_date') || null,
            target_completion: formData.get('target_completion') || null
        };

        try {
            const response = await fetch('/api/projects?' + new URLSearchParams(projectData), {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                alert('Error: ' + error.detail);
                return;
            }

            alert('Project created successfully!');
            hideCreateForm();
            loadProjects(); // Reload list
        } catch (error) {
            console.error('Failed to create project:', error);
            alert('Failed to create project');
        }
    }

    async function deleteProject(projectId) {
        if (!confirm('Are you sure you want to delete this project? Items will remain in the database.')) {
            return;
        }

        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Delete failed');
            }

            alert('ProjectModel deleted successfully');
            loadProjects(); // Reload list
        } catch (error) {
            console.error('Failed to delete project:', error);
            alert('Failed to delete project');
        }
    }
</script>
{% endblock %}