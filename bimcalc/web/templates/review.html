{% extends "base.html" %}

{% block title %}Review - BIMCalc{% endblock %}

{% block extra_styles %}
<style>
    /* Loading overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4299e1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Enhanced form controls */
    select:focus,
    input[type="text"]:focus,
    input[type="checkbox"]:focus {
        outline: 2px solid #4299e1;
        outline-offset: 2px;
    }

    /* Improved button states */
    button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    button:not(:disabled):active {
        transform: translateY(0);
    }

    /* Annotation validation styles */
    input.annotation-required {
        border-color: #f56565 !important;
        background-color: #fff5f5;
    }

    .annotation-hint {
        font-size: 0.75rem;
        color: #718096;
        margin-top: 0.25rem;
    }

    .annotation-error {
        font-size: 0.75rem;
        color: #f56565;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" role="alert" aria-live="polite" aria-label="Loading">
    <div class="loading-spinner"></div>
</div>

<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1>üîç Review Queue</h1>
            <p>Review and approve suggested price matches for {{ project_id }}</p>
        </div>
        <div>
            <a href="/review?org={{ org_id }}&project={{ project_id }}&view=executive" class="btn btn-primary"
                style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                <span>üéØ</span>
                <span>Executive View</span>
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">Filters</div>
    <div class="card-body">
        <form method="get" id="filterForm" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            <input type="hidden" name="org" value="{{ org_id }}" />
            <input type="hidden" name="project" value="{{ project_id }}" />

            <div>
                <label for="flagFilter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 600; color: #4a5568;">Flag
                    Filter</label>
                <select id="flagFilter" name="flag" onchange="handleFilterChange(this)" aria-label="Filter by flag type"
                    style="padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 0.375rem; min-width: 150px; cursor: pointer;">
                    {% set flags = [
                    ("All", "all"),
                    ("Unit Conflict", "Unit Conflict"),
                    ("Size Mismatch", "Size Mismatch"),
                    ("Angle Mismatch", "Angle Mismatch"),
                    ("Material Conflict", "Material Conflict"),
                    ("Class Mismatch", "Class Mismatch"),
                    ("Classification Mismatch", "Classification Mismatch"),
                    ("Stale Price", "StalePrice"),
                    ("Currency/VAT", "CurrencyMismatch"),
                    ("VAT Unclear", "VATUnclear"),
                    ("Vendor Note", "VendorNote")
                    ] %}
                    {% for label, value in flags %}
                    <option value="{{ value }}" {% if flag_filter==value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="severityFilter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 600; color: #4a5568;">Severity</label>
                <select id="severityFilter" name="severity" onchange="handleFilterChange(this)"
                    aria-label="Filter by severity level"
                    style="padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 0.375rem; min-width: 150px; cursor: pointer;">
                    <option value="all" {% if severity_filter=='all' %}selected{% endif %}>All</option>
                    <option value="Critical-Veto" {% if severity_filter=='Critical-Veto' %}selected{% endif %}>Critical
                    </option>
                    <option value="Advisory" {% if severity_filter=='Advisory' %}selected{% endif %}>Advisory</option>
                </select>
            </div>

            <div>
                <label for="classificationFilter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 600; color: #4a5568;">Classification</label>
                <select id="classificationFilter" name="classification" onchange="handleFilterChange(this)"
                    aria-label="Filter by classification code"
                    style="padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 0.375rem; min-width: 180px; cursor: pointer;">
                    <option value="all" {% if classification_filter=='all' %}selected{% endif %}>All Classifications
                    </option>
                    {% for cls in classifications %}
                    <option value="{{ cls.code }}" {% if classification_filter==cls.code %}selected{% endif %}>
                        {{ cls.code }} - {{ cls.name }} ({{ cls.count }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer;">
                    <input id="unmappedFilter" type="checkbox" name="unmapped_only" {% if unmapped_only %}checked{%
                        endif %} onchange="handleFilterChange(this)" aria-label="Show only unmapped items"
                        style="width: auto; margin: 0; cursor: pointer;" />
                    <span style="font-size: 0.875rem; font-weight: 600; color: #4a5568;">Unmapped Only</span>
                </label>
            </div>
        </form>
    </div>
</div>

{% if records %}
<div class="card">
    <div class="card-header">{{ records|length }} Items Pending Review</div>
    <table>
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onclick="toggleAll(this)" aria-label="Select all items"
                        style="cursor: pointer;">
                </th>
                <th>Classification</th>
                <th>Item</th>
                <th>Candidate</th>
                <th>Score</th>
                <th>Docs</th>
                <th style="min-width: 250px;">ü§ñ Smart Suggestions</th>
                <th>Flags</th>
                <th>Action</th>
            </tr>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td style="text-align: center; vertical-align: middle;">
                    <input type="checkbox" name="selected_matches" value="{{ record.match_result_id }}"
                        class="match-checkbox" onclick="updateBulkToolbar()" style="cursor: pointer;">
                </td>
                <td style="text-align: center; vertical-align: middle;">
                    {% if record.item.classification_code %}
                    {% set class_colors = {
                    "62": "#d69e2e",
                    "63": "#38a169",
                    "64": "#ed8936",
                    "66": "#3182ce",
                    "67": "#805ad5",
                    "68": "#e53e3e"
                    } %}
                    {% set class_names = {
                    "62": "Small Power",
                    "63": "Earthing",
                    "64": "Lighting",
                    "66": "Containment",
                    "67": "Emergency",
                    "68": "Fire Detection"
                    } %}
                    <style>
                        .badge-class {
                            display: inline-block;
                            padding: 0.5rem;
                            color: white;
                            border-radius: 0.375rem;
                            font-weight: 700;
                            min-width: 4rem;
                            text-align: center;
                        }

                        .badge-class-62 {
                            background: #d69e2e;
                        }

                        .badge-class-63 {
                            background: #38a169;
                        }

                        .badge-class-64 {
                            background: #ed8936;
                        }

                        .badge-class-66 {
                            background: #3182ce;
                        }

                        .badge-class-67 {
                            background: #805ad5;
                        }

                        .badge-class-68 {
                            background: #e53e3e;
                        }

                        .badge-class-default {
                            background: #718096;
                        }
                    </style>
                    <div class="badge-class badge-class-{{ record.item.classification_code }}">
                        {{ record.item.classification_code }}
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #718096; font-weight: 600;">
                        {{ class_names.get(record.item.classification_code|string, "Class " +
                        record.item.classification_code|string) }}
                    </div>
                    {% else %}
                    <span style="color: #cbd5e0;">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <strong style="color: #2d3748;">{{ record.item.family }}</strong><br />
                    <small style="color: #718096;">{{ record.item.type_name }}</small>
                    {% if record.item.element_id %}
                    <div style="margin-top: 0.25rem;">
                        <code
                            style="font-size: 0.75rem; background: #ebf8ff; color: #2b6cb0; padding: 0.125rem 0.375rem; border-radius: 0.25rem;">ID: {{ record.item.element_id }}</code>
                    </div>
                    {% endif %}
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #718096;">
                        Qty: <strong>{{ "%.2f"|format(record.item.quantity) }}</strong> {{ record.item.unit }}
                    </div>
                </td>
                <td>
                    {% if record.price %}
                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>{{ record.price.sku }}</strong><br />
                            <small style="color: #718096;">{{ record.price.description }}</small>
                            <div style="margin-top: 4px; font-weight: 600; color: #2b6cb0;">
                                {{ record.price.currency }} {{ "%.2f"|format(record.price.unit_price) }} / {{
                                record.price.unit }}
                            </div>
                            {% if record.price.classification_code %}
                            <br /><span class="badge"
                                style="background: #edf2f7; color: #4a5568; margin-top: 0.25rem;">Class: {{
                                record.price.classification_code }}</span>
                            {% endif %}
                        </div>
                        {% if record.is_escape_hatch_match %}
                        <span class="badge"
                            style="background: #fed7d7; color: #c53030; font-weight: 600; white-space: nowrap;"
                            title="Out-of-class match via escape-hatch">‚ö† Out-of-Class</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <span style="color: #cbd5e0;">No candidate</span>
                    {% endif %}
                </td>
                <td>
                    {% if record.confidence_score >= 90 %}
                    <span class="badge badge-success">{{ "%.0f"|format(record.confidence_score) }}%</span>
                    {% elif record.confidence_score >= 70 %}
                    <span class="badge badge-warning">{{ "%.0f"|format(record.confidence_score) }}%</span>
                    {% else %}
                    <span class="badge badge-danger">{{ "%.0f"|format(record.confidence_score) }}%</span>
                    {% endif %}
                </td>
                <td id="docs-{{ record.item.id }}" hx-get="/api/items/{{ record.item.id }}/documents" hx-trigger="load"
                    hx-swap="innerHTML" style="font-size: 0.875rem;">
                    <span class="text-muted">Loading...</span>
                </td>
                <td id="suggestions-{{ record.item.id }}" hx-get="/api/match/{{ record.item.id }}/suggestions"
                    hx-trigger="load" hx-swap="innerHTML" style="font-size: 0.875rem;">
                    <span class="text-muted">ü§ñ Analyzing...</span>
                </td>
                <td>
                    {% if record.flags %}
                    {% for flag in record.flags %}
                    {% if flag.severity == "Critical-Veto" %}
                    <span class="badge badge-danger">{{ flag.type }}</span>
                    {% else %}
                    <span class="badge badge-warning">{{ flag.type }}</span>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <span style="color: #cbd5e0;">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% set has_critical = record.flags and record.flags|selectattr("severity", "equalto",
                    "Critical-Veto")|list %}
                    {% set has_advisory = record.flags and record.flags|selectattr("severity", "equalto",
                    "Advisory")|list %}
                    <form method="post" action="/review/approve" class="approval-form"
                        data-has-advisory="{{ 'true' if has_advisory else 'false' }}"
                        onsubmit="return validateApprovalForm(this)"
                        style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <input type="hidden" name="match_result_id" value="{{ record.match_result_id }}" />
                        <input type="hidden" name="org" value="{{ org_id }}" />
                        <input type="hidden" name="project" value="{{ project_id }}" />
                        <input type="hidden" name="flag" value="{{ flag_filter }}" />
                        <input type="hidden" name="severity" value="{{ severity_filter }}" />
                        <input type="hidden" name="unmapped_only" value="{{ 'on' if unmapped_only else '' }}" />
                        <input type="hidden" name="classification"
                            value="{{ classification_filter if classification_filter != 'all' else '' }}" />

                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="text" name="annotation" class="annotation-input"
                                    placeholder="{% if has_advisory %}Annotation required for advisory flags{% else %}Optional annotation{% endif %}"
                                    aria-label="Annotation for approval" {% if has_advisory %}required{% endif %}
                                    style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 0.375rem; font-size: 0.875rem;" />
                                <div class="annotation-message" style="min-height: 1rem;"></div>
                            </div>
                            <button type="submit" {% if has_critical %} disabled
                                title="Cannot approve - Critical flags present" aria-disabled="true"
                                style="background: #cbd5e0; cursor: not-allowed; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s;"
                                {% else %} aria-label="Approve this item"
                                style="background: #48bb78; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                                {% endif %}>
                                Approve
                            </button>
                        </div>
                    </form>

                    <!-- Reject Form -->
                    <form method="post" action="/review/reject" onsubmit="showLoading()" style="margin-top: 0.5rem;">
                        <input type="hidden" name="match_result_id" value="{{ record.match_result_id }}" />
                        <input type="hidden" name="org" value="{{ org_id }}" />
                        <input type="hidden" name="project" value="{{ project_id }}" />
                        <input type="hidden" name="flag" value="{{ flag_filter }}" />
                        <input type="hidden" name="severity" value="{{ severity_filter }}" />
                        <input type="hidden" name="unmapped_only" value="{{ 'on' if unmapped_only else '' }}" />
                        <input type="hidden" name="classification"
                            value="{{ classification_filter if classification_filter != 'all' else '' }}" />

                        <button type="submit"
                            style="width: 100%; background: #fff; color: #e53e3e; border: 1px solid #e53e3e; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                            onmouseover="this.style.background='#fff5f5'" onmouseout="this.style.background='#fff'">
                            Reject Match
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem; color: #718096;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
        <h3 style="margin-bottom: 0.5rem; color: #2d3748;">No Items to Review</h3>
        <p>All items have been processed or no items match the current filters.</p>
        {% if unmapped_only or (classification_filter and classification_filter != 'all') or (flag_filter and
        flag_filter != 'all') or (severity_filter and severity_filter != 'all') %}
        <p style="margin-top: 1rem;">
            <a href="/review?org={{ org_id }}&project={{ project_id }}"
                style="color: #4299e1; text-decoration: underline;">
                Clear all filters to see all items
            </a>
        </p>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

<!-- Bulk Action Toolbar -->
<div id="bulkToolbar"
    style="display: none; position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: white; padding: 1rem 2rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 10px 15px rgba(0,0,0,0.1); z-index: 1000; align-items: center; gap: 1rem; border: 1px solid #e2e8f0;">
    <span style="font-weight: 600; color: #2d3748;"><span id="selectedCount">0</span> items selected</span>
    <div style="height: 24px; width: 1px; background: #cbd5e0;"></div>
    <button onclick="bulkAction('approve')" class="btn" style="background: #48bb78; color: white; border: none;">Approve
        Selected</button>
    <button onclick="bulkAction('reject')" class="btn" style="background: #f56565; color: white; border: none;">Reject
        Selected</button>
</div>

{% block scripts %}
<script>
    // ... existing scripts ...

    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.match-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateBulkToolbar();
    }

    function updateBulkToolbar() {
        const selected = document.querySelectorAll('.match-checkbox:checked').length;
        const toolbar = document.getElementById('bulkToolbar');
        const countSpan = document.getElementById('selectedCount');

        countSpan.textContent = selected;
        if (selected > 0) {
            toolbar.style.display = 'flex';
        } else {
            toolbar.style.display = 'none';
        }
    }

    async function bulkAction(action) {
        const selected = Array.from(document.querySelectorAll('.match-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) return;

        if (!confirm(`Are you sure you want to ${action} ${selected.length} items?`)) return;

        showLoading();

        try {
            const response = await fetch('/api/matches/bulk-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    match_result_ids: selected,
                    action: action,
                    org_id: "{{ org_id }}",
                    project_id: "{{ project_id }}"
                })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.detail || 'Bulk action failed'));
                hideLoading();
            }
        } catch (error) {
            console.error('Bulk action error:', error);
            alert('An error occurred');
            hideLoading();
        }
    }

    // Show loading indicator
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    // Hide loading indicator
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Handle filter changes with loading feedback
    function handleFilterChange(element) {
        showLoading();
        element.form.submit();
    }

    // Validate approval form
    function validateApprovalForm(form) {
        const hasAdvisory = form.getAttribute('data-has-advisory') === 'true';
        const annotationInput = form.querySelector('.annotation-input');
        const messageDiv = form.querySelector('.annotation-message');
        const annotation = annotationInput.value.trim();

        // Clear previous validation messages
        messageDiv.innerHTML = '';
        annotationInput.classList.remove('annotation-required');

        // Validate annotation for advisory flags
        if (hasAdvisory && !annotation) {
            messageDiv.innerHTML = '<div class="annotation-error">‚ö† Annotation required for advisory flags</div>';
            annotationInput.classList.add('annotation-required');
            annotationInput.focus();
            return false;
        }

        // Show loading indicator during submission
        showLoading();
        return true;
    }

    // Add real-time validation feedback
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('.approval-form');

        forms.forEach(form => {
            const hasAdvisory = form.getAttribute('data-has-advisory') === 'true';
            const annotationInput = form.querySelector('.annotation-input');
            const messageDiv = form.querySelector('.annotation-message');

            if (hasAdvisory && annotationInput) {
                annotationInput.addEventListener('input', function () {
                    const value = this.value.trim();
                    messageDiv.innerHTML = '';
                    this.classList.remove('annotation-required');

                    if (value.length > 0) {
                        messageDiv.innerHTML = '<div class="annotation-hint">‚úì Annotation provided</div>';
                    }
                });

                annotationInput.addEventListener('blur', function () {
                    const value = this.value.trim();
                    if (!value) {
                        messageDiv.innerHTML = '<div class="annotation-hint">Annotation required for advisory flags</div>';
                    }
                });
            }
        });

        // Show hint when page loads
        forms.forEach(form => {
            const hasAdvisory = form.getAttribute('data-has-advisory') === 'true';
            if (hasAdvisory) {
                const messageDiv = form.querySelector('.annotation-message');
                const annotationInput = form.querySelector('.annotation-input');
                if (!annotationInput.value.trim()) {
                    messageDiv.innerHTML = '<div class="annotation-hint">Required for advisory flags</div>';
                }
            }
        });
    });

    // Hide loading on page load (in case back button was used)
    window.addEventListener('pageshow', function (event) {
        hideLoading();
    });

    // Keyboard accessibility for forms
    document.addEventListener('keydown', function (e) {
        // Allow Enter to submit forms when focus is on inputs
        if (e.key === 'Enter' && e.target.classList.contains('annotation-input')) {
            e.target.form.requestSubmit();
        }
    });

    // Smart Suggestions Handler
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('suggestion-btn')) {
            const btn = e.target;
            const itemId = btn.dataset.itemId;
            const priceId = btn.dataset.priceId;
            const desc = btn.dataset.description;
            applySuggestion(itemId, priceId, desc);
        }
    });

    async function applySuggestion(itemId, priceId, description) {
        if (!confirm(`Approve suggestion: "${description}"?`)) return;

        showLoading();

        try {
            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('price_item_id', priceId);
            formData.append('suggestion_description', description);

            // Add current filters
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams) {
                formData.append(key, value);
            }

            const response = await fetch('/review/approve-suggestion', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.detail || 'Failed to approve suggestion'));
                hideLoading();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
            hideLoading();
        }
    }
</script>
{% endblock %}